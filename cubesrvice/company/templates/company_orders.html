{% load custom_filters %}
<!DOCTYPE html>
<html>
<head>
<title>Active Orders</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{
    background:#f4f6f9;
    font-family:'Segoe UI',sans-serif;
}

/* ===== DASHBOARD CONTENT ===== */

/* ===== TITLE ===== */
.container h2{
    margin-bottom:20px;
}

/* ===== ORDER CARD ===== */
.order-card{
    background:#fff;
    padding:20px;
    margin-bottom:25px;
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

/* ===== ORDER HEADER ===== */
.header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    border-bottom:1px solid #eee;
    padding-bottom:10px;
    gap:15px;
    flex-wrap:wrap;
}

.badge{
    background:#4caf50;
    color:#fff;
    padding:4px 12px;
    border-radius:20px;
    font-size:12px;
    white-space:nowrap;
}

/* ===== ITEMS ===== */
.item{
    display:flex;
    gap:15px;
    padding:12px 0;
    border-bottom:1px dashed #ddd;
}

.item img{
    width:70px;
    height:70px;
    border-radius:8px;
    object-fit:cover;
}

.item div{
    font-size:14px;
}

/* ===== USER INFO ===== */
.user{
    font-size:14px;
    color:#555;
}

/* ===== COMPLAINT BOX ===== */
.complaint-box{
    background:#fff3e0;
    padding:12px;
    border-radius:8px;
    margin-bottom:12px;
}

.complaint-box img{
    max-width:100%;
}

/* ===== AUDIO ===== */
audio{
    width:100%;
}

/* ===== MOBILE RESPONSIVE ===== */
@media(max-width:992px){
    .container{
        margin-left:0;
        padding-top:80px; /* mobile header */
    }
}

@media(max-width:576px){
    .item{
        flex-direction:column;
    }

    .item img{
        width:100%;
        height:auto;
        max-width:200px;
    }

    .header{
        flex-direction:column;
        align-items:flex-start;
    }
}
.delete-btn{
    background:#ef4444;
    color:#fff;
    padding:6px 14px;
    border:none;
    border-radius:6px;
    font-size:13px;
    cursor:pointer;
}
.delete-btn:hover{
    opacity:0.9;
}
/* ===== SEARCH BAR ===== */
.search-bar{
    background:#fff;
    padding:12px 16px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:25px;
}

.search-bar i{
    color:#9ca3af;
}

.search-bar input{
    border:none;
    outline:none;
    width:100%;
    font-size:15px;
}

/* Mobile */
@media(max-width:576px){
    .search-bar{
        padding:10px 14px;
    }
}

</style>
</head>

<body>
{% include 'headerr.html' %}

<div class="container">
<h2>üì¶ Active Orders</h2>
<div class="search-bar">
    <i class="fa fa-search"></i>
    <input type="text"
           id="orderSearch"
           placeholder="Search orders, customer, service, pincode..."
           onkeyup="filterOrders()">
</div>


{% for order in orders %}
<div class="order-card searchable-order">


    <!-- ORDER HEADER -->
    <div class="header">
        <div>
            <strong>Order ID:</strong> #{{ order.id }}<br>
            <span class="user">
                üë§ {{ order.fullname }} |
                üìß {{ order.email }} |
                üìû {{ order.mobile }}
            </span>
        </div>
       <p>
    <strong>Order Status:</strong>
    <span class="badge {{ order.status }}">
        {{ order.status|title }}
    </span>
</p>
 <form method="POST"
          action="{% url 'company:delete_company_order' order.id %}"
          onsubmit="return confirm('Are you sure you want to delete this order?');">
        {% csrf_token %}
        <button type="submit" class="delete-btn">
            üóë Delete Order
        </button>
    </form>

    </div>

    <!-- ITEMS -->
    {% for item in order.items.all %}
    <div class="item">
        <img src="{{ item.image }}">
        <div>
            <strong>{{ item.service_name }}</strong><br>
            {{ item.details }}<br>
            {{ item.service_details }}<br>
            {{ item.extra_details }}<br>
            Qty: {{ item.quantity }} | ‚Çπ{{ item.price }}
        </div>
    </div>
    {% empty %}
        <p style="color:red;">No items found for this order</p>
    {% endfor %}

    <!-- ORDER DETAILS -->
    <hr>
    <p><strong>Address:</strong> {{ order.address }}, {{ order.district }} - {{ order.pincode }}</p>
    <p><strong>Service Date:</strong> {{ order.date }}</p>
    <p><strong>Total Amount:</strong> ‚Çπ{{ order.total_price }}</p>
    
    {% with sc=servicecenter_map|get_item:order.pincode %}
    {% if sc %}
        <hr>
        <h4>üè¢ Service Center</h4>
        <p><strong>Name:</strong> {{ sc.servicecenter_name }}</p>
        <p><strong>Author:</strong> {{ sc.author_name }}</p>
        <p><strong>Mobile:</strong> {{ sc.mobile }}</p>
        <p><strong>Email:</strong> {{ sc.email }}</p>
          <p><strong>Pincode:</strong> {{ sc.pincode }}</p>
            <p><strong>district:</strong> {{ sc.district }}</p>
    {% else %}
        <p style="color:red;">‚ö† No service center assigned for this pincode</p>
    {% endif %}
{% endwith %}
    {% with completion=completion_map|get_item:order.id %}
{% if completion %}
<hr>
<h4 style="color:green;">‚úÖ Service Completed Details</h4>

<p><strong>OTP Verified:</strong> 
    {% if completion.otp_verified %}
        Yes
    {% else %}
        No
    {% endif %}
</p>

{% if completion.old_image %}
<p><strong>Old Image:</strong></p>
<img src="{{ completion.old_image.url }}"
     style="max-width:200px; border-radius:8px;">
     <br>
<a href="{{ completion.old_image.url }}"
   download
   class="download-btn">
   ‚¨á Download Old Image
</a>
{% endif %}

{% if completion.new_image %}
<p><strong>New Image:</strong></p>
<img src="{{ completion.new_image.url }}"
     style="max-width:200px; border-radius:8px;">
     <a href="{{ completion.new_image.url }}"
   download
   class="download-btn">
   ‚¨á Download New Image
</a>
{% endif %}

{% endif %}
{% endwith %}



    <!-- COMPLAINTS SECTION -->
    {% if complaint_map|get_item:order.id %}
    <hr>
    <h4 style="color:#e65100;">üì£ Complaints</h4>

    {% for c in complaint_map|get_item:order.id %}
    <div class="complaint-box">
        <p><strong>User:</strong> {{ c.user.username }}</p>

        {% if c.service_name %}
            <p><strong>Service:</strong> {{ c.service_name }}</p>
        {% endif %}

        <p><strong>Complaint:</strong><br>{{ c.complaint_text }}</p>
          
            {% if c.complaint_image %}
    <p><strong>Complaint Image:</strong></p>
    <img src="{{ c.complaint_image.url }}"
         alt="Complaint Image"
         style="max-width:200px; border-radius:8px; margin-top:6px;">
          <a href="{{ c.complaint_image.url }}"
       download
       class="download-btn">
        ‚¨á Download Image
    </a>
{% endif %}

        {% if c.complaint_audio %}
        <audio controls style="width:100%;">
            <source src="{{ c.complaint_audio.url }}">
        </audio>
        {% endif %}

        <small style="color:#777;">üïí {{ c.created_at }}</small>
    </div>
    {% endfor %}
    {% endif %}

</div>
{% endfor %}

</div>
<script>
function filterOrders(){
    let input = document.getElementById("orderSearch").value.toLowerCase();
    let orders = document.getElementsByClassName("searchable-order");

    for(let i = 0; i < orders.length; i++){
        let text = orders[i].innerText.toLowerCase();

        if(text.includes(input)){
            orders[i].style.display = "block";
        } else {
            orders[i].style.display = "none";
        }
    }
}
</script>

</body>
</html>
